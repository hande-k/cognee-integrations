name: Publish Integration

# Triggered by tags: <slug>-v<version>
# Examples:
#   langgraph-v0.1.8       -> publishes cognee-integration-langgraph to PyPI
#   openai-agents-v0.1.1   -> publishes cognee-integration-openai-agents to PyPI
#   openclaw-v2026.2.4     -> publishes @openclaw/memory-cognee to npm

on:
  push:
    tags:
      - '*-v*'

jobs:
  parse-tag:
    runs-on: ubuntu-latest
    outputs:
      slug: ${{ steps.parse.outputs.slug }}
      version: ${{ steps.parse.outputs.version }}
      language: ${{ steps.parse.outputs.language }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Parse tag into slug and version
        id: parse
        run: |
          TAG="${GITHUB_REF#refs/tags/}"
          # Split on last occurrence of -v
          SLUG="${TAG%-v*}"
          VERSION="${TAG##*-v}"

          if [ -z "$SLUG" ] || [ -z "$VERSION" ]; then
            echo "::error::Could not parse tag: $TAG"
            exit 1
          fi

          if [ ! -d "integrations/$SLUG" ]; then
            echo "::error::Integration directory not found: integrations/$SLUG"
            exit 1
          fi

          # Classify language
          if [ -f "integrations/$SLUG/pyproject.toml" ]; then
            LANG="python"
          elif [ -f "integrations/$SLUG/package.json" ]; then
            LANG="typescript"
          else
            echo "::error::Cannot determine language for integrations/$SLUG"
            exit 1
          fi

          echo "slug=$SLUG" >> "$GITHUB_OUTPUT"
          echo "version=$VERSION" >> "$GITHUB_OUTPUT"
          echo "language=$LANG" >> "$GITHUB_OUTPUT"
          echo "Publishing: $SLUG v$VERSION ($LANG)"

  publish-python:
    needs: parse-tag
    if: ${{ needs.parse-tag.outputs.language == 'python' }}
    runs-on: ubuntu-latest
    environment: pypi
    permissions:
      id-token: write  # for trusted publishing
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version-file: ".python-version"

      - name: Install uv
        uses: astral-sh/setup-uv@v4

      - name: Install dependencies
        working-directory: integrations/${{ needs.parse-tag.outputs.slug }}
        run: uv sync --locked --dev

      - name: Run tests before publish
        working-directory: integrations/${{ needs.parse-tag.outputs.slug }}
        run: uv run pytest tests/ -v

      - name: Build package
        working-directory: integrations/${{ needs.parse-tag.outputs.slug }}
        run: uv build

      - name: Publish to PyPI
        working-directory: integrations/${{ needs.parse-tag.outputs.slug }}
        run: uv publish
        env:
          UV_PUBLISH_TOKEN: ${{ secrets.PYPI_API_TOKEN }}

  publish-npm:
    needs: parse-tag
    if: ${{ needs.parse-tag.outputs.language == 'typescript' }}
    runs-on: ubuntu-latest
    environment: npm
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          registry-url: "https://registry.npmjs.org"

      - name: Install dependencies
        working-directory: integrations/${{ needs.parse-tag.outputs.slug }}
        run: npm install

      - name: Type check before publish
        working-directory: integrations/${{ needs.parse-tag.outputs.slug }}
        run: npx tsc --noEmit --skipLibCheck

      - name: Publish to npm
        working-directory: integrations/${{ needs.parse-tag.outputs.slug }}
        run: npm publish --access public
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}
